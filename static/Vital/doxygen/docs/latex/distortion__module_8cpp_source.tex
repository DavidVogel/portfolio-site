\doxysection{distortion\+\_\+module.\+cpp}
\hypertarget{distortion__module_8cpp_source}{}\label{distortion__module_8cpp_source}\index{/Users/davidvogel/repos/VitalHelp/src/synthesis/modules/distortion\_module.cpp@{/Users/davidvogel/repos/VitalHelp/src/synthesis/modules/distortion\_module.cpp}}
\mbox{\hyperlink{distortion__module_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{distortion__module_8h}{distortion\_module.h}}"{}}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{distortion_8h}{distortion.h}}"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{digital__svf_8h}{digital\_svf.h}}"{}}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacevital}{vital}}\ \{}
\DoxyCodeLine{00007\ }
\DoxyCodeLine{00008\ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a15ee67ce4d1ad9339583012ff018e487}{DistortionModule::DistortionModule}}()\ :}
\DoxyCodeLine{00009\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_synth_module}{SynthModule}}(0,\ 1),\ \textcolor{comment}{//\ no\ inputs\ registered\ here,\ 1\ output}}
\DoxyCodeLine{00010\ \ \ \ \ \ \ \ \ \ \ \ \ distortion\_(nullptr),}
\DoxyCodeLine{00011\ \ \ \ \ \ \ \ \ \ \ \ \ filter\_(nullptr),}
\DoxyCodeLine{00012\ \ \ \ \ \ \ \ \ \ \ \ \ mix\_(0.0f)\ \{\ \}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a1caa8c03f3e88319023a679ced552404}{DistortionModule::\string~DistortionModule}}()\ \{}
\DoxyCodeLine{00015\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Clean\ up\ owned\ processors\ if\ needed.}}
\DoxyCodeLine{00016\ \ \ \ \ \}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classvital_1_1_distortion_module_a7cffb1ea57b385c0829b48da69bbe25f}{DistortionModule::init}}()\ \{}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classvital_1_1_distortion}{Distortion}}();}
\DoxyCodeLine{00027\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a4ab8d1bebcc9b45ae4eefb1f0ea20d77}{useOutput}}(\mbox{\hyperlink{classvital_1_1_processor_ab09651265a7270548b77e99b1316fde0}{output}}());}
\DoxyCodeLine{00028\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_processor_router_a8bc90b699c1ec299b060ed0df32f476c}{addIdleProcessor}}(\mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}});}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_value}{Value}}*\ distortion\_type\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_a3829cadfd1dfc7802119541ca1753d69}{createBaseControl}}(\textcolor{stringliteral}{"{}distortion\_type"{}});}
\DoxyCodeLine{00031\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1_output}{Output}}*\ distortion\_drive\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_ae5eccb22cca0d1f82d4c2273a91b0cad}{createMonoModControl}}(\textcolor{stringliteral}{"{}distortion\_drive"{}},\ \textcolor{keyword}{true},\ \textcolor{keyword}{true});}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a01da663c776b1db3ad6ded3fe73cde29}{distortion\_mix\_}}\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_ae5eccb22cca0d1f82d4c2273a91b0cad}{createMonoModControl}}(\textcolor{stringliteral}{"{}distortion\_mix"{}});}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a99005e6f52c7289c548a51065582e3ac}{plug}}(distortion\_type,\ \mbox{\hyperlink{classvital_1_1_distortion_a2747ff2738120129d737495b281b9ddba67b828625c476e6394aefdaab60e8bcb}{Distortion::kType}});}
\DoxyCodeLine{00035\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a99005e6f52c7289c548a51065582e3ac}{plug}}(distortion\_drive,\ \mbox{\hyperlink{classvital_1_1_distortion_a2747ff2738120129d737495b281b9ddbaf5509109255eaa15fc6363b7ada45c39}{Distortion::kDrive}});}
\DoxyCodeLine{00036\ }
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a1f63b6e616e5e8105c7acb648fb7c5fd}{filter\_order\_}}\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_a3829cadfd1dfc7802119541ca1753d69}{createBaseControl}}(\textcolor{stringliteral}{"{}distortion\_filter\_order"{}});}
\DoxyCodeLine{00038\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1_output}{Output}}*\ \mbox{\hyperlink{formant__filter_8cpp_aba4b35a056b330b668e7717ba40a927d}{midi\_cutoff}}\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_ae5eccb22cca0d1f82d4c2273a91b0cad}{createMonoModControl}}(\textcolor{stringliteral}{"{}distortion\_filter\_cutoff"{}},\ \textcolor{keyword}{true},\ \textcolor{keyword}{true});}
\DoxyCodeLine{00039\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1_output}{Output}}*\ \mbox{\hyperlink{formant__filter_8cpp_a763370db72febfa675aff8c7645edb85}{resonance}}\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_ae5eccb22cca0d1f82d4c2273a91b0cad}{createMonoModControl}}(\textcolor{stringliteral}{"{}distortion\_filter\_resonance"{}});}
\DoxyCodeLine{00040\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1_output}{Output}}*\ blend\ =\ \mbox{\hyperlink{classvital_1_1_synth_module_ae5eccb22cca0d1f82d4c2273a91b0cad}{createMonoModControl}}(\textcolor{stringliteral}{"{}distortion\_filter\_blend"{}});}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00042\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}\ =\ \textcolor{keyword}{new}\ \mbox{\hyperlink{classvital_1_1_digital_svf}{DigitalSvf}}();}
\DoxyCodeLine{00043\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a4ab8d1bebcc9b45ae4eefb1f0ea20d77}{useOutput}}(\mbox{\hyperlink{classvital_1_1_processor_ab09651265a7270548b77e99b1316fde0}{output}}());}
\DoxyCodeLine{00044\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a99005e6f52c7289c548a51065582e3ac}{plug}}(\mbox{\hyperlink{formant__filter_8cpp_aba4b35a056b330b668e7717ba40a927d}{midi\_cutoff}},\ \mbox{\hyperlink{classvital_1_1_synth_filter_a03c515d2b209852494e96aaf3ecd1fa0a4b105ff09b198286a6ba3662309bcc2e}{DigitalSvf::kMidiCutoff}});}
\DoxyCodeLine{00045\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a99005e6f52c7289c548a51065582e3ac}{plug}}(\mbox{\hyperlink{formant__filter_8cpp_a763370db72febfa675aff8c7645edb85}{resonance}},\ \mbox{\hyperlink{classvital_1_1_synth_filter_a03c515d2b209852494e96aaf3ecd1fa0a332b06d234cc5a7922c3fb6ece6ed2d6}{DigitalSvf::kResonance}});}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_a99005e6f52c7289c548a51065582e3ac}{plug}}(blend,\ \mbox{\hyperlink{classvital_1_1_synth_filter_a03c515d2b209852494e96aaf3ecd1fa0a2cc3a6b24c80e4c01a37d054aba20767}{DigitalSvf::kPassBlend}});}
\DoxyCodeLine{00047\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_digital_svf_a4af9bb1526338fe23cfbcab373e59937}{setDriveCompensation}}(\textcolor{keyword}{false});}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_digital_svf_ad311a7e98655a10a9e16fbe20edd76b3}{setBasic}}(\textcolor{keyword}{true});}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_processor_router_a8bc90b699c1ec299b060ed0df32f476c}{addIdleProcessor}}(\mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}});}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_processor_adb6eaa40b95275a42029ed4c0c4bcba4}{SynthModule::init}}();}
\DoxyCodeLine{00052\ \ \ \ \ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classvital_1_1_distortion_module_a7d86a74696a462eab3010d23290df877}{DistortionModule::setSampleRate}}(\textcolor{keywordtype}{int}\ sample\_rate)\ \{}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_processor_ac778f37e9b9e3c1c05fca568e8f8664c}{SynthModule::setSampleRate}}(sample\_rate);}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_ac778f37e9b9e3c1c05fca568e8f8664c}{setSampleRate}}(sample\_rate);}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_ac778f37e9b9e3c1c05fca568e8f8664c}{setSampleRate}}(sample\_rate);}
\DoxyCodeLine{00064\ \ \ \ \ \}}
\DoxyCodeLine{00065\ }
\DoxyCodeLine{00066\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classvital_1_1_distortion_module_a3f336113885837d3f7e896c833515377}{DistortionModule::processWithInput}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structvital_1_1poly__float}{poly\_float}}*\ audio\_in,\ \textcolor{keywordtype}{int}\ num\_samples)\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_processor_aa88622055da34fca35bb4192d524dd9d}{SynthModule::process}}(num\_samples);}
\DoxyCodeLine{00074\ }
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Determine\ processing\ order\ based\ on\ filter\ order\ value}}
\DoxyCodeLine{00076\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ order\_value\ =\ \mbox{\hyperlink{classvital_1_1_distortion_module_a1f63b6e616e5e8105c7acb648fb7c5fd}{filter\_order\_}}-\/>\mbox{\hyperlink{classvital_1_1_processor_ab09651265a7270548b77e99b1316fde0}{output}}()-\/>\mbox{\hyperlink{structvital_1_1_output_a1bc2c3a75ee0525ecbfb24fc841b1fe4}{buffer}}[0][0];}
\DoxyCodeLine{00077\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (order\_value\ <\ 1.0f)\ \{}
\DoxyCodeLine{00078\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Only\ distortion}}
\DoxyCodeLine{00079\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_distortion_a01af6ba501eece4e5660954141d6aca3}{processWithInput}}(audio\_in,\ num\_samples);}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (order\_value\ >\ 1.0f)\ \{}
\DoxyCodeLine{00082\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Distortion\ followed\ by\ filter}}
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_distortion_a01af6ba501eece4e5660954141d6aca3}{processWithInput}}(audio\_in,\ num\_samples);}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_digital_svf_aa811bf3852bff005f6c825abec177cb9}{processWithInput}}(\mbox{\hyperlink{classvital_1_1_processor_ab09651265a7270548b77e99b1316fde0}{output}}()-\/>buffer,\ num\_samples);}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00087\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Filter\ first,\ then\ distortion}}
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a19cac949d72d7de4aa4c37cf831812cf}{filter\_}}-\/>\mbox{\hyperlink{classvital_1_1_digital_svf_aa811bf3852bff005f6c825abec177cb9}{processWithInput}}(audio\_in,\ num\_samples);}
\DoxyCodeLine{00089\ \ \ \ \ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_aa0f9176a1a2cb0a9b482a87a46ef529a}{distortion\_}}-\/>\mbox{\hyperlink{classvital_1_1_distortion_a01af6ba501eece4e5660954141d6aca3}{processWithInput}}(\mbox{\hyperlink{classvital_1_1_processor_ab09651265a7270548b77e99b1316fde0}{output}}()-\/>buffer,\ num\_samples);}
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1poly__float}{poly\_float}}\ current\_mix\ =\ \mbox{\hyperlink{classvital_1_1_distortion_module_a8da5e1c2529e797ad1b9dbd77ba020fc}{mix\_}};}
\DoxyCodeLine{00093\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classvital_1_1_distortion_module_a8da5e1c2529e797ad1b9dbd77ba020fc}{mix\_}}\ =\ \mbox{\hyperlink{namespacevital_1_1utils_a13a19cf68aa11afa58de96f14442003a}{utils::clamp}}(\mbox{\hyperlink{classvital_1_1_distortion_module_a01da663c776b1db3ad6ded3fe73cde29}{distortion\_mix\_}}-\/>\mbox{\hyperlink{structvital_1_1_output_a1bc2c3a75ee0525ecbfb24fc841b1fe4}{buffer}}[0],\ 0.0f,\ 1.0f);}
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1poly__float}{poly\_float}}\ delta\_mix\ =\ (\mbox{\hyperlink{classvital_1_1_distortion_module_a8da5e1c2529e797ad1b9dbd77ba020fc}{mix\_}}\ -\/\ current\_mix)\ *\ (1.0f\ /\ num\_samples);}
\DoxyCodeLine{00095\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structvital_1_1poly__float}{poly\_float}}*\ audio\_out\ =\ \mbox{\hyperlink{classvital_1_1_processor_ab09651265a7270548b77e99b1316fde0}{output}}()-\/>\mbox{\hyperlink{structvital_1_1_output_a1bc2c3a75ee0525ecbfb24fc841b1fe4}{buffer}};}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Apply\ wet/dry\ interpolation\ over\ the\ block\ of\ samples.}}
\DoxyCodeLine{00098\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ num\_samples;\ ++i)\ \{}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ \ \ \ \ current\_mix\ +=\ delta\_mix;}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Interpolate\ between\ the\ original\ audio\ and\ the\ processed\ output}}
\DoxyCodeLine{00101\ \ \ \ \ \ \ \ \ \ \ \ \ audio\_out[i]\ =\ \mbox{\hyperlink{namespacevital_1_1utils_ae1ebe307e6064bb3d3bf55a2258d308a}{utils::interpolate}}(audio\_in[i],\ audio\_out[i],\ current\_mix);}
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00103\ \ \ \ \ \}}
\DoxyCodeLine{00104\ \}\ \textcolor{comment}{//\ namespace\ vital}}

\end{DoxyCode}
